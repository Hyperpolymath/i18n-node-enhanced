= polyglot-i18n: Architectural Transformation Roadmap
:toc: macro
:toc-title: Table of Contents
:toclevels: 4
:sectnums:
:icons: font
:source-highlighter: rouge
:experimental:

[.lead]
A comprehensive roadmap for transforming polyglot-i18n from a Node.js/npm library into a ReScript-first, WASM-accelerated, Deno-primary internationalization platform.

[NOTE]
====
*Current Status:* The legacy JavaScript codebase is marked as transitional in `.gitattributes`. Language statistics reflect our target architecture (ReScript, Rust, Scheme), not the current transitional state.
====

toc::[]

== Executive Summary

polyglot-i18n is a fork of https://github.com/mashpie/i18n-node[i18n-node] by Marcus Spiegel, reimagined as a modern polyglot platform:

* **ReScript-first architecture** - minimal JavaScript surface, maximum type safety
* **WebAssembly performance core** - Rust-powered hot paths
* **Deno runtime primary** - npm as legacy compatibility layer only
* **Guix channels primary** - reproducible builds, Nix fallback
* **Chainguard Wolfi containers** - supply-chain security
* **Nickel configuration** - type-safe, programmable configs
* **Comprehensive CLI** - exhaustive option permutations with man pages

== Phase 0: Current State & Immediate Actions

=== 0.1 Project Status

[cols="1,2,1"]
|===
|Component |Status |Action

|Core Implementation
|`i18n.js` - Legacy JavaScript (~1200 lines)
|Migrate to ReScript

|Package Manager
|npm/package.json still primary
|Transition to Deno

|Type Definitions
|`index.d.ts` - TypeScript
|Replace with ReScript types

|Tests
|Mocha/Should.js (~6000 lines JS)
|Migrate to Deno.test

|Examples
|Express/Node.js focused
|Add Deno examples

|Runtime
|Node.js only
|Deno primary, Node compat
|===

=== 0.2 Immediate Migration Steps

.Step 1: Create Deno Entry Point
[source,typescript]
----
// deno/mod.ts - Deno-native entry point
export { I18n, type I18nConfig } from "./core.ts"
export { translate, __, __n, __mf } from "./translate.ts"
export { plural } from "./plural.ts"
----

.Step 2: Port Core to TypeScript/Deno (Intermediate)
[source]
----
deno/
├── mod.ts              # Main exports
├── core.ts             # I18n class (port from i18n.js)
├── translate.ts        # Translation functions
├── plural.ts           # Plural rules (CLDR)
├── messageformat.ts    # ICU MessageFormat
├── locale.ts           # Locale detection/management
├── catalog.ts          # Translation catalog I/O
├── deps.ts             # External dependencies
└── types.ts            # Type definitions
----

.Step 3: Establish ReScript Core
[source]
----
src/
├── I18n.res            # Main module
├── I18n.resi           # Interface
├── Locale.res          # Locale types
├── Catalog.res         # Translation catalog
├── Plural.res          # CLDR plural rules
├── MessageFormat.res   # ICU formatting
└── Interop.res         # JS/Deno FFI
----

=== 0.3 Dependency Transition

[cols="1,2,2"]
|===
|npm Dependency |Deno Equivalent |Migration Path

|`@messageformat/core`
|`npm:@messageformat/core` or Rust WASM
|npm specifier initially, WASM later

|`make-plural`
|`npm:make-plural` or Rust WASM
|npm specifier initially, WASM later

|`mustache`
|Deno-native implementation
|Port or find Deno module

|`fast-printf`
|`@std/fmt` or custom
|Use Deno std library

|`debug`
|`@std/log`
|Use Deno std library

|`math-interval-parser`
|Rust WASM
|Implement in WASM core
|===

== Phase 1: Deno-First Runtime

=== 1.1 Deno Module Structure

.deno.json Configuration
[source,json]
----
{
  "name": "@polyglot/i18n",
  "version": "0.16.0",
  "exports": {
    ".": "./deno/mod.ts",
    "./core": "./deno/core.ts",
    "./plural": "./deno/plural.ts"
  },
  "tasks": {
    "test": "deno test --allow-read",
    "bench": "deno bench",
    "compile": "deno compile --output=polyglot-i18n deno/cli.ts"
  }
}
----

.Deliverables
* [x] `deno.json` - Deno configuration
* [ ] `deno/mod.ts` - Main entry point
* [ ] `deno/core.ts` - Core I18n class
* [ ] `deno/translate.ts` - Translation functions
* [ ] `deno/plural.ts` - Plural rule engine
* [ ] `deno/messageformat.ts` - MessageFormat parser
* [ ] `deno/catalog.ts` - File I/O for catalogs
* [ ] `deno/middleware.ts` - Framework middleware (Oak, Hono)

=== 1.2 Node.js Compatibility Layer

.npm Compatibility (Legacy Support)
[source,typescript]
----
// For npm users migrating gradually
import { I18n } from "npm:polyglot-i18n"

// Or via package.json (Deno reads this)
{
  "imports": {
    "polyglot-i18n": "npm:polyglot-i18n@^0.16.0"
  }
}
----

.Deliverables
* [ ] Maintain `package.json` for npm compatibility
* [ ] Add `"type": "module"` for ESM
* [ ] Export from both `index.js` and Deno
* [ ] Conditional exports for Node/Deno

== Phase 2: ReScript Core Implementation

=== 2.1 ReScript Project Structure

.rescript.json Configuration
[source,json]
----
{
  "name": "polyglot-i18n",
  "sources": [
    { "dir": "src", "subdirs": true }
  ],
  "package-specs": [{
    "module": "es6",
    "in-source": false
  }],
  "suffix": ".bs.mjs",
  "warnings": { "error": "+101" },
  "bs-dependencies": [],
  "gentypeconfig": {
    "language": "typescript",
    "shims": {},
    "module": "es6",
    "debug": { "all": false }
  }
}
----

.ReScript Module Hierarchy
[source]
----
src/
├── core/
│   ├── I18n.res              # Main API
│   ├── I18n.resi             # Public interface
│   ├── Locale.res            # Locale type and operations
│   ├── Catalog.res           # Translation catalog
│   ├── Translation.res       # Translation logic
│   └── Config.res            # Configuration types
├── plural/
│   ├── Plural.res            # CLDR plural rules
│   ├── PluralRules.res       # Rule definitions
│   └── PluralCategory.res    # Category types
├── format/
│   ├── MessageFormat.res     # ICU MessageFormat
│   ├── Interpolation.res     # Variable interpolation
│   ├── Mustache.res          # Mustache templating
│   └── Printf.res            # sprintf formatting
├── runtime/
│   ├── Platform.res          # Runtime detection
│   ├── FileSystem.res        # File I/O abstraction
│   └── Cache.res             # Translation cache
└── bindings/
    ├── Deno.res              # Deno FFI
    ├── Node.res              # Node.js FFI
    └── Wasm.res              # WASM FFI
----

=== 2.2 Migration Strategy

.Incremental Migration Path
[plantuml, migration-path, svg]
....
@startuml
state "Legacy JS" as js {
  [i18n.js]
}

state "Deno TS" as ts {
  [deno/mod.ts]
  [deno/core.ts]
}

state "ReScript" as res {
  [src/I18n.res]
  [src/Plural.res]
}

state "Generated" as gen {
  [lib/I18n.bs.mjs]
}

js --> ts : Port core logic
ts --> res : Migrate module by module
res --> gen : Compile ReScript
gen --> ts : Import generated code
@enduml
....

.Priority Order for Migration
1. `Locale.res` - Pure data types, easy start
2. `Plural.res` - Self-contained CLDR logic
3. `Config.res` - Configuration types
4. `Interpolation.res` - String processing
5. `MessageFormat.res` - ICU parsing
6. `Catalog.res` - File I/O
7. `I18n.res` - Main API (last, depends on all)

== Phase 3: WASM Performance Core

=== 3.1 Rust WASM Modules

.Crate Structure
[source]
----
wasm/
├── Cargo.toml
├── src/
│   ├── lib.rs              # Main entry
│   ├── plural.rs           # CLDR plural engine
│   ├── interpolate.rs      # Fast string interpolation
│   ├── hash.rs             # Translation key lookup
│   └── messageformat.rs    # ICU parser
└── pkg/                    # wasm-pack output
    ├── polyglot_i18n.js
    ├── polyglot_i18n_bg.wasm
    └── polyglot_i18n.d.ts
----

.Performance Targets
[cols="1,2,1"]
|===
|Module |Purpose |Expected Speedup

|`plural.wasm`
|CLDR plural rule evaluation
|~10x over JS

|`hash.wasm`
|Translation key lookup (large catalogs)
|~5x over JS Map

|`interpolate.wasm`
|Template variable substitution
|~3x over JS regex
|===

=== 3.2 WASM Integration

.Loading Strategy
[source,typescript]
----
// deno/wasm.ts - WASM loader
const wasmModule = await WebAssembly.instantiateStreaming(
  fetch(new URL("./pkg/polyglot_i18n_bg.wasm", import.meta.url))
)

export const evaluatePlural = wasmModule.exports.evaluate_plural
export const interpolate = wasmModule.exports.interpolate
----

== Phase 4: Guix-First Packaging

=== 4.1 Guix Package Definition

.guix.scm Deliverables
* [x] `guix.scm` - Package definitions
* [x] `channels.scm` - Channel configuration
* [x] `.guix-channel` - Channel metadata
* [x] `manifest.scm` - Development manifest

.Guix Packages
[source,scheme]
----
;; Available packages:
;; - polyglot-i18n          (main library)
;; - polyglot-i18n-cli      (command-line tool)
;; - polyglot-i18n-wasm     (WASM modules)
;; - polyglot-i18n-dev      (development environment)
----

=== 4.2 Nix Fallback

.flake.nix Integration
[source,nix]
----
{
  inputs.guix-compat.url = "github:nix-community/guix-nixpkgs";

  outputs = { self, nixpkgs, guix-compat }: {
    packages.default = /* Nix package mirroring Guix */;
    devShells.default = /* Dev shell with Guix tooling */;
  };
}
----

== Phase 5: Container Infrastructure

=== 5.1 Chainguard Wolfi Builds

.Container Variants
[cols="1,2,1"]
|===
|Variant |Base |Size Target

|`polyglot-i18n:runtime`
|`cgr.dev/chainguard/node:latest`
|< 50MB

|`polyglot-i18n:deno`
|`cgr.dev/chainguard/wolfi-base`
|< 100MB

|`polyglot-i18n:cli`
|`cgr.dev/chainguard/static:latest`
|< 20MB

|`polyglot-i18n:dev`
|`cgr.dev/chainguard/wolfi-base`
|< 500MB
|===

=== 5.2 apko Declarative Builds

.container/apko.yaml
[source,yaml]
----
contents:
  repositories:
    - https://packages.wolfi.dev/os
  packages:
    - wolfi-base
    - nodejs-20
    - deno

accounts:
  groups:
    - groupname: i18n
      gid: 65532
  users:
    - username: i18n
      uid: 65532
      gid: 65532

entrypoint:
  command: /usr/bin/polyglot-i18n
----

== Phase 6: CLI & Configuration

=== 6.1 Nickel Configuration

.config/i18n.ncl Deliverables
* [x] `i18n.ncl` - Type-safe config schema
* [x] Environment presets (dev, prod, staging, test)
* [x] Framework presets (Express, NestJS, Deno)
* [ ] Config validation CLI integration

=== 6.2 Comprehensive CLI

.Command Structure
[source]
----
polyglot-i18n <command> [options]

Commands:
  init          Initialize configuration
  translate     Translate strings/files
  validate      Validate locale files
  sync          Synchronize translations
  extract       Extract translatable strings
  compile       Compile to optimized format
  serve         Start translation server
  migrate       Migrate between formats
  benchmark     Run performance benchmarks
  config        Manage configuration
  doctor        Diagnose issues
----

.Man Pages
[source]
----
man/
├── man1/
│   ├── polyglot-i18n.1
│   ├── polyglot-i18n-init.1
│   ├── polyglot-i18n-translate.1
│   └── ...
├── man5/
│   └── polyglot-i18n.ncl.5
└── man7/
    ├── polyglot-i18n-tutorial.7
    └── polyglot-i18n-plural.7
----

== Phase 7: Testing & Quality

=== 7.1 Test Migration

.From Mocha to Deno.test
[cols="1,2"]
|===
|Current |Target

|`test/*.test.js` (Mocha)
|`deno/**/*_test.ts` (Deno.test)

|`nyc` coverage
|`deno coverage`

|`should.js` assertions
|`@std/assert`
|===

.Test Commands
[source]
----
# Deno testing (primary)
deno task test
deno task test:coverage

# Legacy npm testing (transitional)
deno task legacy:test
----

=== 7.2 Performance Benchmarks

.Benchmark Suite
[source,typescript]
----
// benchmarks/translate_bench.ts
Deno.bench("simple translation", () => {
  i18n.translate("hello")
})

Deno.bench("plural translation", () => {
  i18n.translatePlural("%s item", "%s items", 5)
})

Deno.bench("messageformat", () => {
  i18n.translateMf("{N, plural, one{# cat} other{# cats}}", { N: 3 })
})
----

== Milestones

[cols="1,1,2"]
|===
|Version |Target |Milestone

|0.16.0
|Current
|Infrastructure setup (Guix, Nickel, containers, deno.json)

|0.17.0
|Next
|Deno entry point functional, basic API

|0.18.0
|+1
|ReScript core modules (Locale, Plural, Config)

|0.19.0
|+2
|WASM plural engine, performance baselines

|1.0.0-alpha
|+3
|Full ReScript core, Deno primary

|1.0.0-beta
|+4
|CLI complete, documentation site

|1.0.0
|+5
|Production release, npm compatibility stable
|===

== Appendix: Migration Commands

.Quick Start with Deno
[source,bash]
----
# Install from JSR (when published)
deno add @polyglot/i18n

# Or import directly
import { I18n } from "jsr:@polyglot/i18n"

# Or use npm compatibility
import { I18n } from "npm:polyglot-i18n"
----

.Development Commands
[source,bash]
----
# Deno development
deno task dev          # Watch mode
deno task test         # Run tests
deno task bench        # Benchmarks
deno task check        # Type check

# ReScript development
just rescript-build    # Build ReScript
just rescript-watch    # Watch mode
just rescript-clean    # Clean build

# Legacy (npm)
just npm-test          # Run npm tests
just npm-lint          # Lint JS files
----

== License

polyglot-i18n is released under the MIT License. Original i18n-node by Marcus Spiegel.

---

_Document version: 2.0_
_Last updated: 2025-12-07_
